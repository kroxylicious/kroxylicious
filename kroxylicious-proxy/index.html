<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Kroxylicious Proxy</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body id="using-book-proxy" class="book toc2 toc-left">
<div id="header">
<h1>Kroxylicious Proxy</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#assembly-overview-proxy">1. Kroxylicious Proxy overview</a>
<ul class="sectlevel2">
<li><a href="#con-proxy-overview-proxy">1.1. Why use proxies?</a></li>
<li><a href="#con-api-compatibilityproxy">1.2. Compatibility</a></li>
</ul>
</li>
<li><a href="#assembly-configuring-proxy-proxy">2. Configuring proxies</a>
<ul class="sectlevel2">
<li><a href="#con-configuration-outline-proxy">2.1. Outline of a Kroxylicious configuration</a></li>
<li><a href="#ref-configuring-filters-proxy">2.2. Defining filters</a></li>
<li><a href="#con-configuring-virtual-clusters-proxy">2.3. Configuring virtual clusters</a></li>
<li><a href="#con-configuring-vc-gateways-proxy">2.4. Configuring virtual cluster gateways</a></li>
<li><a href="#con-configuring-client-connections-proxy">2.5. Securing connections from clients</a></li>
<li><a href="#con-configuring-target-cluster-connections-proxy">2.6. Securing connections to target clusters</a></li>
<li><a href="#ref-configuring-vc-other-settings-proxy">2.7. Configuring other Virtual Cluster settings</a></li>
<li><a href="#ref-configuring-toplevel-other-settings-proxy">2.8. Configuring other top level settings</a></li>
<li><a href="#ref-configuring-proxy-example-proxy">2.9. Example Kroxylicious configuration</a></li>
</ul>
</li>
<li><a href="#assembly-built-in-filters-proxy">3. Built-in filters</a>
<ul class="sectlevel2">
<li><a href="#record_encryption_filter">3.1. Record Encryption filter</a></li>
<li><a href="#record_validation_filter">3.2. Record Validation filter</a></li>
<li><a href="#assembly-multi-tenancy-filter-proxy">3.3. (Preview) Multi-tenancy filter</a></li>
<li><a href="#con-oauthbearer-proxy">3.4. OAUTHBEARER validation</a></li>
</ul>
</li>
<li><a href="#con-community-filters-proxy">4. Community filters</a></li>
<li><a href="#assembly-proxy-monitoring-proxy">5. Monitoring proxies</a>
<ul class="sectlevel2">
<li><a href="#proc-proxy-introducing-metrics-proxy">5.1. Introducing metrics</a></li>
<li><a href="#con-prometheus-metrics-proxy-proxy">5.2. Overview of proxy metrics</a></li>
<li><a href="#con-proxy-ingesting-metrics-proxy">5.3. Ingesting metrics</a></li>
<li><a href="#con-proxy-integrating-micrometer-proxy">5.4. Integrating Micrometer</a></li>
<li><a href="#proc-proxy-setting-log-levels-proxy">5.5. Setting log levels</a></li>
</ul>
</li>
<li><a href="#trademark_notice">6. Trademark notice</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<h2 id="about_this_guide" class="discrete">About this guide</h2>
<div class="paragraph">
<p>This guide covers installing, configuring, securing, and operating the Kroxylicious Proxy in a non-Kubernetes environment.
Refer to other Kroxylicious guides for information on running the proxy on Kubernetes using the Kroxylicious Operator, or for advanced topics such as plugin development.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-overview-proxy"><a class="anchor" href="#assembly-overview-proxy"></a><a class="link" href="#assembly-overview-proxy">1. Kroxylicious Proxy overview</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Kroxylicious is an Apache Kafka protocol-aware ("Layer 7") proxy designed to enhance Kafka-based systems.
Through its filter mechanism it allows additional behavior to be introduced into a Kafka-based system without requiring changes to either your applications or the Kafka cluster itself.
Built-in filters are provided as part of the solution.</p>
</div>
<div class="paragraph">
<p>Functioning as an intermediary, the Kroxylicious mediates communication between a Kafka cluster and its clients.
It takes on the responsibility of receiving, filtering, and forwarding messages.</p>
</div>
<div class="paragraph">
<p>A Java API provides a convenient means for implementing custom logic within the proxy.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kafka.apache.org" target="_blank" rel="noopener">Apache Kafka website</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="con-proxy-overview-proxy"><a class="anchor" href="#con-proxy-overview-proxy"></a><a class="link" href="#con-proxy-overview-proxy">1.1. Why use proxies?</a></h3>
<div class="paragraph">
<p>Proxies are a powerful and flexible architectural pattern.
For Kafka, they can be used to add functionality to Kafka clusters which is not available out-of-the-box with Apache Kafka.
In an ideal world, such functionality would be implemented directly in Apache Kafka.
But there are numerous practical reasons that can prevent this, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Organizations having very niche requirements which are unsuitable for implementation directly in Apache Kafka.</p>
</li>
<li>
<p>Functionality which requires changes to Kafka&#8217;s public API and which the Apache Kafka project is unwilling to implement.
This is the case for <a href="https://lists.apache.org/thread/x1p119hkpoy01vq9ck3d0ql67jtvm875">broker interceptors</a>, for example.</p>
</li>
<li>
<p>Experimental functionality which might end up being implemented in Apache Kafka eventually.
For example using Kroxylicious it&#8217;s easier to experiment with alternative transport protocols, such as Quic, or operating system APIs, such as io_uring, because there is already support for this in Netty, the networking framework on which Kroxylicious is built.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="how_kroxylicious_works"><a class="anchor" href="#how_kroxylicious_works"></a><a class="link" href="#how_kroxylicious_works">1.1.1. How Kroxylicious works</a></h4>
<div class="paragraph">
<p>First let&#8217;s define the concepts in the landscape surrounding Kroxylicious.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Kafka Client</em>, or <em>Client</em> refers to any client application using a Kafka Client library to talk to a <strong>Kafka Cluster</strong>.</p>
</li>
<li>
<p><em>Kafka Cluster</em> or <em>Cluster</em> refers to a cluster comprising one or more Kafka Brokers.</p>
</li>
<li>
<p><em>Downstream</em> refers to the area between Kafka Client and Kroxylicious.</p>
</li>
<li>
<p><em>Upstream</em> refers to the area between Kroxylicious and a Kafka Cluster.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="../_assets/landscape.svg" alt="Diagram showing Kroxylicious in the context of the applications and the brokers">
</div>
<div class="title">Figure 1. Kroxylicious landscape</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s define some concepts used within Kroxylicious itself.</p>
</div>
<div class="sect4">
<h5 id="virtual_cluster"><a class="anchor" href="#virtual_cluster"></a><a class="link" href="#virtual_cluster">Virtual cluster</a></h5>
<div class="paragraph">
<p>The <em>Virtual Cluster</em> is the downstream representation of a Kafka Cluster.  At the conceptual level, a Kafka Client
connects to a Virtual Cluster.  Kroxylicious proxies all communications made to the Virtual Cluster through to a
(physical) Kafka Cluster, passing it through the <em>Filter Chain</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="virtual_cluster_gateway"><a class="anchor" href="#virtual_cluster_gateway"></a><a class="link" href="#virtual_cluster_gateway">Virtual cluster gateway</a></h5>
<div class="paragraph">
<p>Each virtual cluster has one or more dedicated gateways, which Kafka clients use to establish connections.</p>
</div>
<div class="paragraph">
<p>Each gateway exposes a bootstrap endpoint, which the Kafka Client must specify in its configuration as the <a href="https://kafka.apache.org/documentation/#producerconfigs_bootstrap.servers"><code>bootstrap.servers</code></a> property.</p>
</div>
<div class="paragraph">
<p>In addition to the bootstrap endpoint, the gateway automatically exposes broker endpoints. There is one broker endpoint
for each broker of the physical cluster.  When the Client connects to a broker endpoint, Kroxylicious proxies all
communications to the corresponding broker of the (physical) Kafka Cluster.</p>
</div>
<div class="paragraph">
<p>Kroxylicious automatically intercepts all the Kafka RPC responses that contain a broker address.  It rewrites the address
so that it refers to the corresponding broker endpoint of the Virtual Cluster.  This means when the Kafka Client
goes to connect to, say broker 0, it does so through the Virtual Cluster.</p>
</div>
<div class="paragraph">
<p>Defining multiple gateways for a virtual cluster is useful when exposing it across different network segments.
For example, in Kubernetes, you might configure one gateway for on-cluster traffic and another for off-cluster traffic.</p>
</div>
</div>
<div class="sect4">
<h5 id="target_cluster"><a class="anchor" href="#target_cluster"></a><a class="link" href="#target_cluster">Target cluster</a></h5>
<div class="paragraph">
<p>The <em>Target Cluster</em> is the definition of physical Kafka Cluster within the Kroxylicious itself.</p>
</div>
<div class="paragraph">
<p>A <em>Virtual Cluster</em> has exactly one <em>Target Cluster</em>.</p>
</div>
<div class="paragraph">
<p>There can be a <em>one-to-one</em> relationship between Virtual Clusters and Target Clusters.
The other possibility is <em>many-to-one</em>, where many Virtual Clusters point to the same Target Cluster.  The
many-to-one pattern is exploited by filters such as the <a href="multi-tenancy/proc-multi-tenancy.html#proc-multi-tenancy-proxy">Multi-tenancy</a>
filter.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_assets/cluster_topology_one_to_one.svg" alt="Diagram showing a single virtual cluster proxying a single kafka cluster">
</div>
<div class="title">Figure 2. One-to-One relationship between Virtual Cluster and Target Cluster</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../_assets/cluster_topology_many_to_one.svg" alt="Diagram showing many virtual clusters proxying the same kafka cluster">
</div>
<div class="title">Figure 3. Many-to-one between Virtual Cluster and Target Cluster</div>
</div>
<div class="paragraph">
<p>A one-to-many pattern, where one Virtual Cluster points to many Target Clusters (providing amalgamation),
is not a supported use-case.</p>
</div>
</div>
<div class="sect4">
<h5 id="filter_chain"><a class="anchor" href="#filter_chain"></a><a class="link" href="#filter_chain">Filter chain</a></h5>
<div class="paragraph">
<p>A <em>Filter Chain</em> consists of an <strong>ordered list</strong> of pluggable <em>protocol filters</em>.</p>
</div>
<div class="paragraph">
<p>A  <em>protocol filter</em> implements some logic for intercepting, inspecting and/or manipulating Kafka protocol messages.
Kafka protocol requests (such as <code>Produce</code> requests) pass sequentially through each of the protocol filters in the
chain, beginning with the 1st filter in the chain and then following with the subsequent filters, before being
forwarded to the broker.</p>
</div>
<div class="paragraph">
<p>When the broker returns a response (such as a <code>Produce</code> response) the protocol filters in the chain are invoked in the
reverse order (that is, beginning with the nth filter in the chain, then the n-1th and so on) with each having the
opportunity to inspect and/or manipulating the response. Eventually a response is returned to the client.</p>
</div>
<div class="paragraph">
<p>The description above describes only the basic capabilities of the protocol filter. Richer features of filters
are described later.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_assets/cluster-filter-chain.svg" alt="Diagram showing a kafka request message (and its response) being manipulated by several filters.">
</div>
<div class="title">Figure 4. Illustration of a request and response being manipulated by filters in a chain</div>
</div>
<div class="paragraph">
<p>As mentioned above, Kroxylicious takes the responsibility to rewrite the Kafka RPC responses that carry broker address
information so that they reflect the broker addresses exposed by the Virtual Cluster. These are the
<a href="https://kafka.apache.org/protocol.html#The_Messages_Metadata"><code>Metadata</code></a>,
<a href="https://kafka.apache.org/protocol.html#The_Messages_DescribeCluster"><code>DescribeCluster</code></a> and
<a href="https://kafka.apache.org/protocol.html#The_Messages_FindCoordinator"><code>FindCoordinator</code></a> responses. This processing is
entirely transparent to the work of the protocol filters.  <em>Filter authors</em> are free to write their own filters that
intercept these responses too.</p>
</div>
</div>
<div class="sect4">
<h5 id="filter_composition"><a class="anchor" href="#filter_composition"></a><a class="link" href="#filter_composition">Filter composition</a></h5>
<div class="paragraph">
<p>An important principal for the protocol filter API is that filters should <em>compose</em> nicely.
That means that filters generally don&#8217;t know what other filters might be present in the chain, and what they might be doing to messages.
When a filter forwards a request or response it doesn&#8217;t know whether the message is being sent to the next filter in the chain, or straight back to the client.</p>
</div>
<div class="paragraph">
<p>Such composition is important because it means a <em>proxy user</em> can configure multiple filters (possibly written by several <em>filter authors</em>) and expect to get the combined effect of all of them.</p>
</div>
<div class="paragraph">
<p>It&#8217;s never quite that simple, of course.
In practice, they will often need to understand what each filter does in some detail in order to be able to operate their proxy properly, for example by understanding whatever metrics each filter is emitting.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="implementation"><a class="anchor" href="#implementation"></a><a class="link" href="#implementation">1.1.2. Implementation</a></h4>
<div class="paragraph">
<p>The proxy is written in Java, on top of <a href="https://netty.io">Netty</a>.
The usual <a href="https://netty.io/4.1/api/io/netty/channel/ChannelHandler.html"><code>ChannelHandlers</code></a> provided by the Netty project are used where appropriate (e.g. SSL support uses <a href="https://netty.io/4.1/api/io/netty/handler/ssl/SslHandler.html"><code>SslHandler</code></a>), and Kroxylicious provides Kafka-specific handlers of its own.</p>
</div>
<div class="paragraph">
<p>The Kafka-aware parts use the Apache Kafka project&#8217;s own classes for serialization and deserialization.</p>
</div>
<div class="paragraph">
<p>Protocol filters get executed using a handler-per-filter model.</p>
</div>
</div>
<div class="sect3">
<h4 id="deployment_topologies"><a class="anchor" href="#deployment_topologies"></a><a class="link" href="#deployment_topologies">1.1.3. Deployment topologies</a></h4>
<div class="paragraph">
<p>The proxy supports a range of possible deployment topologies.
Which style is used depends on what the proxy is meant to <em>achieve</em>, architecturally speaking.
Broadly speaking a proxy instance can be deployed:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">As a forward proxy</dt>
<dd>
<p>Proxying the access of one or more clients to a particular cluster/broker that might also accessible (to other clients) directly.</p>
<div class="paragraph">
<p>Topic-level encryption provides one example use case for a forward proxy-style deployment.
This might be applicable when using clients that don&#8217;t support interceptors, or if an organization wants to apply the same encryption policy in a single place, securing access to the keys within their network.</p>
</div>
</dd>
<dt class="hdlist1">As a reverse proxy</dt>
<dd>
<p>Proxying access for all clients trying to reach a particular cluster/broker.</p>
<div class="paragraph">
<p>Transparent multi-tenancy provides an example use case for a reverse proxy.
While Apache Kafka itself has some features that enable multi-tenancy, they rely on topic name prefixing as the primary mechanism for ensuring namespace isolation.
Tenants have to adhere to the naming policy and know they&#8217;re a tenant of a larger shared cluster.</p>
</div>
<div class="paragraph">
<p><em>Transparent</em> multi-tenancy means each tenant has the illusion of having their own cluster, with almost complete freedom over topic and group naming, while still actually sharing a cluster.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>We can further classify deployment topologies in how many proxy instances are used.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Single proxy instance (sidecar)</p>
</li>
<li>
<p>Proxy pool</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-api-compatibilityproxy"><a class="anchor" href="#con-api-compatibilityproxy"></a><a class="link" href="#con-api-compatibilityproxy">1.2. Compatibility</a></h3>
<div class="sect3">
<h4 id="con-api-compatibility-apiproxy"><a class="anchor" href="#con-api-compatibility-apiproxy"></a><a class="link" href="#con-api-compatibility-apiproxy">1.2.1. APIs</a></h4>
<div class="paragraph">
<p>Kroxylicious follows <a href="https://semver.org/#semantic-versioning-200">Semantic Versioning</a> rules. While we are still in the initial development phase (denoted by a major version 0), we still take API compatibility very seriously. We aim to provide at least two minor releases between deprecation and the removal of that deprecated item.</p>
</div>
<div class="paragraph">
<p>We also consider our configuration file syntax a public API (though not the Java model backing it). As such, the syntax follows the same Semantic Versioning and deprecation rules.</p>
</div>
<div class="paragraph">
<p>Kubernetes custom resources are a public API, and we are making every effort to evolve Kroxylicious custom resources in line with <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/">Kubernetes best practices</a>.</p>
</div>
<div class="paragraph">
<p>Kubernetes resources have their own versioning scheme, which is independent of the Kroxylicious Proxy service version. As a result, Kroxylicious may reach version 1.0.0 while still using alpha or beta versions of the custom resources.</p>
</div>
<div class="sect4">
<h5 id="con-api-compatibility-third-partyproxy"><a class="anchor" href="#con-api-compatibility-third-partyproxy"></a><a class="link" href="#con-api-compatibility-third-partyproxy">Third-party plugins</a></h5>
<div class="paragraph">
<p>Kroxylicious supports loading third-party plugins to extend the core functionality of the project. While these plugins are configured and loaded as first-class entities within Kroxylicious, we cannot guarantee the compatibility of their APIs or configuration properties.</p>
</div>
<div class="paragraph">
<p>We do however hold filters and plugins provided by the project to the same standards as the rest of the public API.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-api-compatibility-wire-protocolproxy"><a class="anchor" href="#con-api-compatibility-wire-protocolproxy"></a><a class="link" href="#con-api-compatibility-wire-protocolproxy">1.2.2. Wire protocol</a></h4>
<div class="paragraph">
<p>Kroxylicious offers the same backwards and forwards compatibility guarantees as <a href="https://kafka.apache.org/protocol#protocol_compatibility">Apache Kafka</a>. We support the same range of client and broker versions as the official Apache Kafka Java client.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-configuring-proxy-proxy"><a class="anchor" href="#assembly-configuring-proxy-proxy"></a><a class="link" href="#assembly-configuring-proxy-proxy">2. Configuring proxies</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Fine-tune your deployment by configuring proxies to include additional features according to your specific requirements.</p>
</div>
<div class="sect2">
<h3 id="con-configuration-outline-proxy"><a class="anchor" href="#con-configuration-outline-proxy"></a><a class="link" href="#con-configuration-outline-proxy">2.1. Outline of a Kroxylicious configuration</a></h3>
<div class="paragraph _abstract">
<p>The following example shows the overall outline of a simple Kroxylicious configuration.
While not complete (as indicated by <code># &#8230;&#8203;</code>), it illustrates the essential structure.</p>
</div>
<div id="con-basic-structure-proxy" class="listingblock">
<div class="title">Basic outline of a Kroxylicious configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">filterDefinitions: <i class="conum" data-value="1"></i><b>(1)</b>
  - name: example <i class="conum" data-value="2"></i><b>(2)</b>
    type: org.example.filter.Example <i class="conum" data-value="3"></i><b>(3)</b>
    config: <i class="conum" data-value="4"></i><b>(4)</b>
      # ...
defaultFilters: <i class="conum" data-value="5"></i><b>(5)</b>
  - example
virtualClusters: <i class="conum" data-value="6"></i><b>(6)</b>
  - name: my-cluster-proxy
    targetCluster: <i class="conum" data-value="7"></i><b>(7)</b>
      # ...
    gateways: <i class="conum" data-value="8"></i><b>(8)</b>
    - name: ...
      # ...
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A list of named filter definitions.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A filter definition called <code>example</code>. The definitions must each have a unique name.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The name of the filter class implementation for the <code>example</code> filter. Required.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The configuration for the <code>example</code> filter instance. Usually required for non-trivial filters.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A list of default filters. It&#8217;s possible to override this list at the virtual cluster level.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>List of virtual clusters specified by name, with cluster-specific configurations.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Configuration of the actual Kafka cluster that is proxied by the 'my-cluster-proxy' virtual cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Configuration of the gateways for this virtual cluster.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ref-configuring-filters-proxy"><a class="anchor" href="#ref-configuring-filters-proxy"></a><a class="link" href="#ref-configuring-filters-proxy">2.2. Defining filters</a></h3>
<div class="paragraph">
<p>Filters in Kroxylicious can be defined globally with <code>filterDefinitions</code>, applied by default using <code>defaultFilters</code>, or customized for specific virtual clusters.
The following example shows how these elements work together flexibly:</p>
</div>
<div id="con-filterDefinitions-defaultFilters-proxy" class="listingblock">
<div class="title">Example configuration showing global filter definitions applied as defaults and to virtual cluster</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">filterDefinitions:
  - name: encryption
    type: RecordEncryption
    config:
      # ...
  - name: validation
    type: RecordValidation
    config:
      # ...
  - name: special-encryption
    type: RecordEncryption
    config:
      # ...
defaultFilters:
  - validation
  - encryption
virtualClusters:
  - name: my-proxy-with-default-filters
    # ...
  - name: my-proxy-with-custom-filters
    filters:
      - validation
      - special-encryption
    # ...
# ...</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The order of definitions in <code>filterDefinitions</code> does not matter.</p>
</li>
<li>
<p>Each filter definition in <code>filterDefinitions</code> must have a unique <code>name</code>, but you can have multiple definitions with the same type and different configurations (as with <code>encryption</code> and <code>special-encryption</code> in the example).</p>
</li>
<li>
<p>The order of <code>defaultFilters</code> determines the sequence in which the filters are applied to incoming client requests. In the example, records are first validated and then encrypted.</p>
</li>
<li>
<p>The <code>defaultFilters</code> are used for all virtual clusters which don&#8217;t define their own <code>filters</code>, such as <code>my-proxy-with-default-filters</code>.</p>
</li>
<li>
<p>The <code>defaultFilters</code> property is optional. It is useful when all virtual clusters must use the same filters. There&#8217;s no need to specify it if all virtual clusters have specific <code>filters</code> defined.</p>
</li>
<li>
<p>When a virtual cluster has defined <code>filters</code>, like <code>my-proxy-with-custom-filters</code>, then those filters are used instead of the <code>defaultFilters</code>.</p>
</li>
<li>
<p>When using <code>defaultFilters</code> or a virtual cluster&#8217;s <code>filters</code> to reference a filter definition, you must define a filter with the corresponding name in <code>filterDefinitions</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="con-configuring-virtual-clusters-proxy"><a class="anchor" href="#con-configuring-virtual-clusters-proxy"></a><a class="link" href="#con-configuring-virtual-clusters-proxy">2.3. Configuring virtual clusters</a></h3>
<div class="paragraph _abstract">
<p>A Kafka cluster is represented by the proxy as a virtual cluster.
Clients communicate with the virtual cluster rather than the actual cluster.
When Kroxylicious is deployed, it includes configuration to create virtual clusters.</p>
</div>
<div class="paragraph">
<p>A virtual cluster has exactly one target cluster, but many virtual clusters can target the same cluster.
Each virtual cluster targets a single listener on the target cluster, so multiple listeners on the Kafka side are represented as multiple virtual clusters by the proxy.
Clients connect to a virtual cluster using a <code>bootstrapServers</code> address.
The virtual cluster has a bootstrap address that maps to each broker in the target cluster.
When a client connects to the proxy, communication is proxied to the target broker by rewriting the address.
Responses back to clients are rewritten to reflect the appropriate network addresses of the virtual clusters.</p>
</div>
<div class="paragraph">
<p>You can secure virtual cluster connections from clients and to target clusters.</p>
</div>
<div class="paragraph">
<p>Kroxylicious accepts keys and certificates in PEM (Privacy Enhanced Mail), PKCS #12 (Public-Key Cryptography Standards), or JKS (Java KeyStore) keystore format.</p>
</div>
</div>
<div class="sect2">
<h3 id="con-configuring-vc-gateways-proxy"><a class="anchor" href="#con-configuring-vc-gateways-proxy"></a><a class="link" href="#con-configuring-vc-gateways-proxy">2.4. Configuring virtual cluster gateways</a></h3>
<div class="paragraph _abstract">
<p>Clients connect to a virtual cluster gateway.
Each gateway provides a bootstrap address for the initial connection.
The gateway also facilitates communication between clients and proxied brokers.
This can be implemented in two ways:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Port Identifies Node</dt>
<dd>
<p>The gateway binds separate portsone for each broker as well as an additional one for the bootstrap address.
Clients make connections to the different port numbers to interact with each broker.</p>
</dd>
<dt class="hdlist1">SNI Host Identifies Node</dt>
<dd>
<p>The gateway assigns a unique hostname to each broker.
Clients make connections to these distinct hostnames to interact with the respective brokers.
The gateway uses SNI (Server Name Indication) to identify the target broker for the client&#8217;s connection.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You must make sure that the gateway&#8217;s bootstrap address and generated broker addresses are resolvable and routable by the Kafka Client. You must also make sure firewall rules permit traffic to required port numbers.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="port_identifies_node"><a class="anchor" href="#port_identifies_node"></a><a class="link" href="#port_identifies_node">2.4.1. Port Identifies Node</a></h4>
<div class="paragraph">
<p>In the Port Identifies Node scheme, the virtual cluster opens a separate port for each proxied broker in addition to
a separate port for the bootstrap.</p>
</div>
<div class="paragraph">
<p>By default, this scheme assumes that the target cluster comprises three nodes with broker ids 0..2.
If this is inadequate, additional configuration can be provided describing the broker topology of the target broker.</p>
</div>
<div class="paragraph">
<p>This scheme can be used with both plain and TLS downstream connections.</p>
</div>
<div class="paragraph">
<p>This scheme works best with straightforward configurations where the target cluster uses a known minimum broker ID and uses stable sets of broker IDs.
For more complex cases, it is recommended to use the SNI Host Identifies Node scheme.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When using this scheme, you have the responsibility to avoid port number collision. Ensure that each gateway has its own range of port numbers and these do not overlap with the range used by another gateway, or the gateway of another virtual cluster.
</td>
</tr>
</table>
</div>
<div id="con-configuring-vc-gateways-port-identifies-node-proxy" class="listingblock">
<div class="title">Example Port Identifies Node configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      portIdentifiesNode:
        bootstrapAddress: localhost:9192 <i class="conum" data-value="1"></i><b>(1)</b>
    # ...
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The bootstrap address used by Kafka clients.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the example configuration above, the gateway exposes a target cluster of up to three brokers with node ids <code>0</code>, <code>1</code>, <code>2</code>.
The advertised address is defaulted to that of the bootstrap host name.
Port numbers are assigned sequentially beginning at bootstrap port number + 1.</p>
</div>
<div class="paragraph">
<p>The gateway exposes the following three broker addresses:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Node Id</th>
<th class="tableblock halign-left valign-top">Broker Address</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">localhost:9193</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">localhost:9194</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">localhost:9195</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example Port Identifies Node configuration with customized broker address</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      portIdentifiesNode:
        bootstrapAddress: localhost:9192 <i class="conum" data-value="1"></i><b>(1)</b>
        advertisedBrokerAddressPattern: mycluster.example.com <i class="conum" data-value="2"></i><b>(2)</b>
        brokerStartPort: 9200 <i class="conum" data-value="3"></i><b>(3)</b>
    # ...
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The bootstrap address used by Kafka clients.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>(Optional) The advertised broker address pattern used to form broker addresses. If not defined, it defaults to the hostname part of the bootstrap address.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) The starting number for the broker port range. Defaults to the port of the bootstrap address plus 1.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the example configuration above, the gateway exposes a target cluster of up to three brokers with node ids <code>0</code>, <code>1</code>, <code>2</code>.
The advertised broker address is defined as <code>mycluster.example.com</code>.
Port numbers are assigned sequentially beginning at <code>9200</code>.</p>
</div>
<div class="paragraph">
<p>The gateway exposes the following three broker addresses:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Node Id</th>
<th class="tableblock halign-left valign-top">Broker Address</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mycluster.example.com:9200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mycluster.example.com:9201</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mycluster.example.com:9202</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example Port Identifies Node configuration with customized node ranges</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      portIdentifiesNode:
        bootstrapAddress: localhost:9192 <i class="conum" data-value="1"></i><b>(1)</b>
        advertisedBrokerAddressPattern: mycluster.example.com <i class="conum" data-value="2"></i><b>(2)</b>
        nodeIdRanges: <i class="conum" data-value="3"></i><b>(3)</b>
        - name: mixed
          start: 1
          end: 3
        - name: brokers
          start: 101
          end: 103

    # ...
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The bootstrap address used by Kafka clients.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>(Optional) The advertised broker address pattern used to form broker addresses. If not defined, it defaults to the hostname part of the bootstrap address.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) One or more node id ranges.  If omitted, it defaults to a single range of node IDs 0..2 (inclusive).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the example configuration above, the gateway exposes a target cluster of up to six nodes with node ids <code>1..3</code> and <code>101..103</code>.
The advertised broker address is defined as <code>mycluster.example.com</code>.
Port numbers are assigned sequentially beginning at <code>9193</code> (bootstrap port number + 1).</p>
</div>
<div class="paragraph">
<p>The gateway exposes the following six broker addresses:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Node Id</th>
<th class="tableblock halign-left valign-top">Broker Address</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mycluster.example.com:9193</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mycluster.example.com:9194</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mycluster.example.com:9195</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">101</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mycluster.example.com:9196</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">102</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mycluster.example.com:9197</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">103</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mycluster.example.com:9198</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>advertisedBrokerAddressPattern</code> configuration parameter accepts the <code>$(nodeId)</code> replacement token, which is optional.
If included, <code>$(nodeId)</code> is replaced by the broker&#8217;s <a href="https://kafka.apache.org/documentation/#brokerconfigs_node.id"><code>node.id</code></a> (or <a href="https://kafka.apache.org/documentation/#brokerconfigs_broker.id"><code>broker.id</code></a>) in the target cluster.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-configuring-vc-gateways-snihost-identifies-node-proxy"><a class="anchor" href="#con-configuring-vc-gateways-snihost-identifies-node-proxy"></a><a class="link" href="#con-configuring-vc-gateways-snihost-identifies-node-proxy">2.4.2. SNI Host Identifies Node</a></h4>
<div class="paragraph">
<p>In the SNI Host Identifies Node scheme, unique broker hostnames are used to know where to route the traffic.
As this scheme relies on SNI (Server Name Indication), which is a TLS extension, TLS connections are required. It cannot be used with plain text connections.</p>
</div>
<div class="paragraph">
<p>In this scheme, you can either share the port across multiple virtual cluster gateways or assign a separate port
for each virtual cluster gateway.
However, you cannot use a port that is already assigned to a virtual cluster gateway using the Port Identifies Node scheme.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When using this scheme, you have the responsibility to make sure that DNS for bootstrap and brokers resolve
to an IP address that is routed to the proxy. Wildcard DNS is one way to achieve this.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example SNI Host Identifies Node configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      sniHostIdentifiesNode:
        bootstrapAddress: mycluster.example.com:9192 <i class="conum" data-value="1"></i><b>(1)</b>
        advertisedBrokerAddressPattern: mybroker-$(nodeId).mycluster.example.com <i class="conum" data-value="2"></i><b>(2)</b>
      tls:
         key: ... <i class="conum" data-value="3"></i><b>(3)</b>
    # ...
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The bootstrap address used by Kafka clients.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The advertised broker address pattern used to form broker addresses. It must include the placeholder $(nodeId) which
is substituted for the node ID.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>TLS configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the example configuration above, the gateway accepts all traffic on port 9192.
Any TLS connections received with the SNI of <code>mycluster.example.com</code> are routed as bootstrap.
Any connections received with SNI matching <code>mybroker-$(nodeId).mycluster.example.com</code> are routed to the upstream broker with the same node ID.
The configuration exposes a target cluster with any number of brokers. It does not need prior knowledge of the node IDs used by the brokers.</p>
</div>
<div class="paragraph">
<p>The gateway exposes the following broker addresses:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Node Id</th>
<th class="tableblock halign-left valign-top">Broker Address</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybroker-0.mycluster.example.com:9192</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>n</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybroker-<em>n</em>.mycluster.example.com:9192</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Both the <code>advertisedBrokerAddressPattern</code> and <code>bootstrapAddress</code> configuration parameters accept the <code>$(virtualClusterName)</code> replacement token,
which is optional. If included, <code>$(virtualClusterName)</code> is replaced with the name of the gateway&#8217;s virtual cluster.</p>
</div>
<div class="listingblock">
<div class="title">Example SNI Host Identifies Node configuration with customized advertised port</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      sniHostIdentifiesNode:
        bootstrapAddress: mycluster.example.com:9192 <i class="conum" data-value="1"></i><b>(1)</b>
        advertisedBrokerAddressPattern: mybroker-$(nodeId).mycluster.example.com:443 <i class="conum" data-value="2"></i><b>(2)</b>
      tls:
         key: ... <i class="conum" data-value="3"></i><b>(3)</b>
    # ...
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The bootstrap address used by Kafka clients.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The advertised broker address pattern and port number used to form broker addresses. It must include the placeholder $(node)
which will be substituted for the node id.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>TLS configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the example configuration above, Kroxylicious is instructed to listen on port 9192, but advertise brokers of this virtual cluster as
being available on port 443. This feature is useful where a network intermediary (such as another proxy or
load balancer) is port forwarding.</p>
</div>
<div class="paragraph">
<p>The gateway exposes the following broker addresses:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Node Id</th>
<th class="tableblock halign-left valign-top">Broker Address</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybroker-0.mycluster.example.com:443</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>n</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybroker-<em>n</em>.mycluster.example.com:443</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Single port operation may have cost advantages when using load balancers of public clouds, as it allows
a single cloud provider load balancer to be shared across all virtual clusters.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-configuring-client-connections-proxy"><a class="anchor" href="#con-configuring-client-connections-proxy"></a><a class="link" href="#con-configuring-client-connections-proxy">2.5. Securing connections from clients</a></h3>
<div class="paragraph _abstract">
<p>To secure client connections to virtual clusters, configure TLS within the virtual cluster gateway by doing the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain a server certificate for the virtual cluster from a Certificate Authority (CA).<br>
Ensure the certificate matches the names of the virtual cluster gateway&#8217;s bootstrap and broker addresses.<br>
This may require wildcard certificates and Subject Alternative Names (SANs).</p>
</li>
<li>
<p>Provide the TLS configuration using the <code>tls</code> properties in the virtual cluster gateway&#8217;s configuration to enable it to present the certificate to clients.
Depending on your certificate format, apply one of the following examples.</p>
</li>
<li>
<p>For mutual TLS, use the <code>trust</code> properties to configure the virtual cluster gateway to use TLS client authentication.</p>
</li>
<li>
<p>If required, you can restrict the TLS protocols and cipher suites that are used to form the TLS connection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples below illustrate how these steps may be done.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TLS is recommended for production configurations.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example applying a PKCS #12 server certificate to a virtual cluster gateway</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      # ...
      tls:
        key:
          storeFile: &lt;path&gt;/server.p12  <i class="conum" data-value="1"></i><b>(1)</b>
          storePassword:
            passwordFile: &lt;path&gt;/store.password <i class="conum" data-value="2"></i><b>(2)</b>
          keyPassword:
            passwordFile: &lt;path&gt;/key.password <i class="conum" data-value="3"></i><b>(3)</b>
          storeType: PKCS12 <i class="conum" data-value="4"></i><b>(4)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>PKCS #12 store containing the private-key and certificate/intermediates of the virtual cluster gateway.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Password to protect the PKCS #12 store.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) Password for the key. If a password is not specified, the keystores password is used to decrypt the key too.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>(Optional) Keystore type. If a keystore type is not specified, the default JKS (Java Keystore) type is used.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example applying a PEM server certificate and key pair to a virtual cluster gateway</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      # ...
      tls:
        key:
          privateKeyFile: &lt;path&gt;/server.key   <i class="conum" data-value="1"></i><b>(1)</b>
          certificateFile: &lt;path&gt;/server.crt <i class="conum" data-value="2"></i><b>(2)</b>
          keyPassword:
            passwordFile: &lt;path&gt;/key.password <i class="conum" data-value="3"></i><b>(3)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Private key of the virtual cluster gateway.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Public certificate of the virtual cluster gateway.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) Password for the key.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can configure the virtual cluster gateway to require that clients present a certificate for authentication.
The virtual cluster gateway verifies that the client&#8217;s certificate is signed by one of the CA certificates contained in a trust store.
If verification fails, the client&#8217;s connection is refused.</p>
</div>
<div class="listingblock">
<div class="title">Example applying TLS client authentication using a PKCS #12 truststore</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      # ...
      tls:
        key:
           # ...
        trust:
          storeFile: &lt;path&gt;/trust.p12 <i class="conum" data-value="1"></i><b>(1)</b>
          storePassword:
            passwordFile: &lt;path&gt;/trust.password <i class="conum" data-value="2"></i><b>(2)</b>
          storeType: PKCS12 <i class="conum" data-value="3"></i><b>(3)</b>
          trustOptions:
            clientAuth: REQUIRED <i class="conum" data-value="4"></i><b>(4)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>PKCS #12 store containing CA certificates used to verify that the client&#8217;s certificate is trusted.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>(Optional) Password to protect the PKCS #12 store.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) Keystore type. If a keystore type is not specified, the default JKS (Java Keystore) type is used.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>(Optional) Client authentication mode.
If set to <code>REQUIRED</code>, the client must present a valid certificate.
If set to <code>REQUESTED</code>, the client is requested to present a certificate. If presented, the certificate is validated. If the client chooses not to present a certificate the connection is still allowed.
If set to <code>NONE</code>, client authentication is disabled.
If a client authentication mode is not specified, then the default behaviour is <code>REQUIRED</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The client&#8217;s identity, as established through TLS client authentication, is currently not relayed to the target cluster.
For more information, see the <a href="https://github.com/kroxylicious/kroxylicious/issues/1637" target="_blank" rel="noopener">related issue</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can restrict the TLS protocols by specifying either an allow list of TLS protocols to be enabled, or a deny list of
TLS protocols to be disallowed from the platform&#8217;s default.
If both an allow and a deny list are specified, the resulting list of TLS protocols includes only those protocols from the
allow list that are not in the deny list.
If neither list is specified, the virtual cluster uses the default TLS protocols provided by the platform.</p>
</div>
<div class="paragraph">
<p>When the client connects, it negotiates the highest mutually acceptable TLS protocol with the virtual cluster.
If the two have no protocols in common, the connection fails.</p>
</div>
<div class="paragraph">
<p>The names of the TLS protocols are defined by <a href="https://docs.oracle.com/en/java/javase/17/docs/specs/security/standard-names.html#sslcontext-algorithms">Java specification</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example restricting TLS protocols using an allow list</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      # ...
      tls:
        # ...
        protocols:
          allowed:  <i class="conum" data-value="1"></i><b>(1)</b>
          - TLSv1.3
          - TLSv1.2</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List of allowed TLS protocols.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example restricting TLS protocols using a deny list</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      # ...
      tls:
        # ...
        protocols:
          denied:  <i class="conum" data-value="1"></i><b>(1)</b>
          - TLSv1.1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List of disallowed TLS protocols.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can restrict the TLS cipher suite by specifying either an allow list of cipher suites to be enabled, in preference
order, or a deny list of ciphers suites to be disallowed from the platform&#8217;s default.
If both an allow and a deny list are specified, the resulting list of cipher suites includes only those ciphers from the
allow list that are not in the deny list.
If neither list is specified, the virtual cluster uses the default cipher suites (and preference order) provided by the platform.</p>
</div>
<div class="paragraph">
<p>When the client connects, it negotiates the most preferred mutually acceptable cipher suite with the virtual cluster.
If the two have no cipher suites in common, the connection fails.</p>
</div>
<div class="paragraph">
<p>The names of the cipher suite are defined by <a href="https://docs.oracle.com/en/java/javase/17/docs/specs/security/standard-names.html#jsse-cipher-suite-names">Java specification</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example restricting cipher suites using an allow list</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      # ...
      tls:
        # ...
        cipherSuites:
          allowed:  <i class="conum" data-value="1"></i><b>(1)</b>
          - TLS_ECDHE_ECDSA_WITH_AES_256_CCM
          - TLS_ECDHE_ECDSA_WITH_AES_128_CCM</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List of allowed cipher suites in preference order.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example restricting cipher suites using a deny list</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">virtualClusters:
  - name: my-cluster-proxy
    # ...
    gateways:
    - name: mygateway
      # ...
      tls:
        # ...
        cipherSuites:
          denied:  <i class="conum" data-value="1"></i><b>(1)</b>
          - TLS_KRB5_WITH_3DES_EDE_CBC_MD5</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List of disallowed cipher suites.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="con-configuring-target-cluster-connections-proxy"><a class="anchor" href="#con-configuring-target-cluster-connections-proxy"></a><a class="link" href="#con-configuring-target-cluster-connections-proxy">2.6. Securing connections to target clusters</a></h3>
<div class="paragraph _abstract">
<p>To secure connections from the virtual cluster to the upstream cluster, configure the target cluster&#8217;s TLS setting by
doing the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the upstream is using a private CA, use the <code>trust</code> properties to configure a truststore for the target cluster.</p>
</li>
<li>
<p>If you want to use mutual TLS, specify the certificate with the <code>key</code> property to identify the virtual cluster to the upstream.</p>
</li>
<li>
<p>If required, you can restrict the TLS protocols and cipher suites that are used to form the TLS connection.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TLS is recommended on Kafka clients and virtual clusters for production configurations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Examples below illustrate how these steps may be done.</p>
</div>
<div class="paragraph">
<p>Using an empty object (<code>{}</code>) enables TLS using the platform&#8217;s defaults. This means that platform trust, and
default protocols and cipher suites will be used. This option is suitable if the upstream cluster is using a TLS
certificate signed by a public CA and the platform&#8217;s defaults are suitable.</p>
</div>
<div class="listingblock">
<div class="title">Example enabling TLS for a target cluster using platform defaults</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    targetCluster:
      bootstrapServers: my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093
      tls: {}
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it is using a TLS certificate signed by a private CA, you must add truststore configuration for the target cluster.
The example illustrates using PKCS #12 format. PEM format is supported too.</p>
</div>
<div class="listingblock">
<div class="title">Example specifying a truststore</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    targetCluster:
      bootstrapServers: my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093
      tls:
        trust:
          storeFile: &lt;path&gt;/trust.p12 <i class="conum" data-value="1"></i><b>(1)</b>
          storePassword:
            passwordFile: &lt;path&gt;/store.password <i class="conum" data-value="2"></i><b>(2)</b>
          storeType: PKCS12 <i class="conum" data-value="3"></i><b>(3)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>PKCS #12 store for the public CA certificate of the Kafka cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Password to access the public Kafka cluster CA certificate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) Keystore type. If a keystore type is not specified, the default JKS (Java Keystore) type is used.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For mutual TLS, add a keystore configuration for the virtual cluster.
The following example uses a PEM format server certificate and key pair.
PKCS #12 keystore format is supported too.</p>
</div>
<div class="listingblock">
<div class="title">Example configuring mutual TLS</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    targetCluster:
      bootstrapServers: my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093
      tls:
        key:
          privateKeyFile: &lt;path&gt;/client.key <i class="conum" data-value="1"></i><b>(1)</b>
          certificateFile: &lt;path&gt;/client.crt <i class="conum" data-value="2"></i><b>(2)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Private key of the virtual cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Public CA certificate of the virtual cluster.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The TLS protocols and cipher suites available to the TLS connection may also be configured.</p>
</div>
<div class="listingblock">
<div class="title">Example restricting TLS protocols using an allow list</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    targetCluster:
      bootstrapServers: my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093
      tls:
        # ...
        protocols:
          allowed:  <i class="conum" data-value="1"></i><b>(1)</b>
          - TLSv1.3
          - TLSv1.2</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List of allowed TLS protocols.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example restricting TLS protocols using a deny list</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">virtualClusters:
  - name: my-cluster-proxy
    targetCluster:
      bootstrapServers: my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093
      tls:
        # ...
        protocols:
          denied:  <i class="conum" data-value="1"></i><b>(1)</b>
          - TLSv1.1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List of disallowed TLS protocols.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example restricting cipher suites using an allow list</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">virtualClusters:
  - name: my-cluster-proxy
    targetCluster:
      bootstrapServers: my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093
      tls:
        # ...
        cipherSuites:
          allowed:  <i class="conum" data-value="1"></i><b>(1)</b>
          - TLS_ECDHE_ECDSA_WITH_AES_256_CCM
          - TLS_ECDHE_ECDSA_WITH_AES_128_CCM</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List of allowed cipher suites.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example restricting cipher suites using a deny list</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">virtualClusters:
  - name: my-cluster-proxy
    targetCluster:
      bootstrapServers: my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093
      tls:
        # ...
        cipherSuites:
          denied:  <i class="conum" data-value="1"></i><b>(1)</b>
          - TLS_KRB5_WITH_3DES_EDE_CBC_MD5</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List of disallowed cipher suites.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the purposes of testing (that is, outside a production environment), you can set the <code>insecure</code> property to <code>true</code>
to disable TLS trust checks (hostname verification and certificate validation) so that the Kroxylicious can connect to
any Kafka cluster.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration to disable TLS trust checks</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">virtualClusters:
  - name: my-cluster-proxy
    targetCluster:
      bootstrapServers: dev-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093
      tls:
        trust:
          insecure: true
# ...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ref-configuring-vc-other-settings-proxy"><a class="anchor" href="#ref-configuring-vc-other-settings-proxy"></a><a class="link" href="#ref-configuring-vc-other-settings-proxy">2.7. Configuring other Virtual Cluster settings</a></h3>
<div class="sect3">
<h4 id="per_virtual_cluster_logging"><a class="anchor" href="#per_virtual_cluster_logging"></a><a class="link" href="#per_virtual_cluster_logging">2.7.1. Per-virtual cluster logging</a></h4>
<div class="paragraph">
<p>You can enable low level logging on a per-virtual cluster basis.
The <code>logNetwork</code> property controls logging of information about requests and responses at the network level, before they&#8217;ve been decoded into Kafka requests and responses.
The <code>logFrames</code> property controls logging of the decoded requests and responses.</p>
</div>
<div id="con-configuring-vc-logging-proxy" class="listingblock">
<div class="title">Configuration fragment showing logging properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
virtualClusters:
  - name: my-cluster-proxy
    # ...
    logNetwork: true <i class="conum" data-value="1"></i><b>(1)</b>
    logFrames: true <i class="conum" data-value="2"></i><b>(2)</b>
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enables low-level network logging for the virtual cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enables low-level protocol frame logging for the virtual cluster.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ref-configuring-toplevel-other-settings-proxy"><a class="anchor" href="#ref-configuring-toplevel-other-settings-proxy"></a><a class="link" href="#ref-configuring-toplevel-other-settings-proxy">2.8. Configuring other top level settings</a></h3>
<div class="sect3">
<h4 id="management_http_endpoints"><a class="anchor" href="#management_http_endpoints"></a><a class="link" href="#management_http_endpoints">2.8.1. Management HTTP endpoints</a></h4>
<div class="paragraph">
<p>The proxy can run an HTTP server for exposing basic management information.
This is configured with the top level <code>management</code> property.</p>
</div>
<div id="con-configuring-admin-http-proxy" class="listingblock">
<div class="title">Configuration fragment showing the <code>management</code> property</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ... (filterDefinitions, virtualClusters etc)
management:
  bindAddress: 0.0.0.0 <i class="conum" data-value="1"></i><b>(1)</b>
  port: 9190 <i class="conum" data-value="2"></i><b>(2)</b>
  endpoints: <i class="conum" data-value="3"></i><b>(3)</b>
    prometheus: {} <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The address the HTTP server should bind to. Defaults to <code>0.0.0.0</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The port the HTTP server should bind to. Defaults to <code>9190</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Control over the exposed endpoints</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If present and not null, exposes a Prometheus scrape endpoint at path <code>/metrics</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ref-configuring-proxy-example-proxy"><a class="anchor" href="#ref-configuring-proxy-example-proxy"></a><a class="link" href="#ref-configuring-proxy-example-proxy">2.9. Example Kroxylicious configuration</a></h3>
<div class="ulist">
<ul>
<li>
<p>Virtual clusters that represent the Kafka clusters</p>
</li>
<li>
<p>Network addresses for broker communication in a Kafka cluster</p>
</li>
<li>
<p>Filters to introduce additional functionality to the Kafka deployment</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this example, configuration for the Record Encryption filter is shown.</p>
</div>
<div id="con-deploying-upstream-tls-proxy" class="listingblock">
<div class="title">Example Kroxylicious configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">filterDefinitions: <i class="conum" data-value="1"></i><b>(1)</b>
  - name: encryption
    type: RecordEncryption <i class="conum" data-value="2"></i><b>(2)</b>
    config: <i class="conum" data-value="3"></i><b>(3)</b>
      kms: VaultKmsService
      kmsConfig:
        vaultTransitEngineUrl: https://vault.vault.svc.cluster.local:8200/v1/transit
        vaultToken:
          passwordFile: /opt/proxy/server/token.txt
        tls: <i class="conum" data-value="4"></i><b>(4)</b>
          key:
            storeFile: /opt/cert/server.p12
            storePassword:
              passwordFile: /opt/cert/store.password
            keyPassword:
              passwordFile: /opt/cert/key.password
            storeType: PKCS12
      selector: TemplateKekSelector
      selectorConfig:
        template: "$(topicName)"
defaultFilters:
  - encryption
virtualClusters: <i class="conum" data-value="5"></i><b>(5)</b>
  - name: my-cluster-proxy <i class="conum" data-value="6"></i><b>(6)</b>
    targetCluster:
      bootstrapServers: my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093 <i class="conum" data-value="7"></i><b>(7)</b>
      tls: <i class="conum" data-value="8"></i><b>(8)</b>
        trust:
          storeFile: /opt/proxy/trust/ca.p12
          storePassword:
            passwordFile: /opt/proxy/trust/ca.password
    gateways: <i class="conum" data-value="9"></i><b>(9)</b>
    - name: mygateway
      sniHostIdentifiesNode: <i class="conum" data-value="10"></i><b>(10)</b>
        bootstrapAddress: my-cluster-proxy.kafka:9092 <i class="conum" data-value="11"></i><b>(11)</b>
        advertisedBrokerAddressPattern: broker$(nodeId).my-cluster-proxy.kafka
      tls: <i class="conum" data-value="12"></i><b>(12)</b>
        key:
          storeFile: /opt/proxy/server/key-material/keystore.p12
          storePassword:
            passwordFile: /opt/proxy/server/keystore-password/storePassword</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A list of named filter configurations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The type of filter, which is the Record Encryption filter using Vault as the KMS in this example.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The configuration specific to the type of filter.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If required, you can also specify the credentials for TLS authentication with the KMS, with key names under which TLS certificates are stored.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Virtual cluster configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The name of the virtual cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The bootstrap address of the target physical Kafka Cluster being proxied.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>TLS configuration for the connection to the target cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The gateway of the virtual cluster defining how the virtual cluster is presented to the network.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The identification scheme used to route traffic to brokers, which can be <code>sniHostIdentifiesNode</code> or <code>portIdentifiesNode</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The hostname and port of the bootstrap used by the Kafka clients to connect to the gateway. The hostname must be resolved by the clients.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>TLS encryption used by the gateway for securing connections with the clients.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-built-in-filters-proxy"><a class="anchor" href="#assembly-built-in-filters-proxy"></a><a class="link" href="#assembly-built-in-filters-proxy">3. Built-in filters</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Kroxylicious comes with a suite of built-in filters designed to enhance the functionality and security of your Kafka clusters.</p>
</div>
<div class="sect2">
<h3 id="record_encryption_filter"><a class="anchor" href="#record_encryption_filter"></a><a class="link" href="#record_encryption_filter">3.1. Record Encryption filter</a></h3>
<div class="paragraph">
<p>The Kroxylicious Record Encryption filter enables encryption-at-rest for Apache Kafka clusters.
For information on using the filter, see the <a href="../record-encryption-guide/">Kroxylicious Record Encryption guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="record_validation_filter"><a class="anchor" href="#record_validation_filter"></a><a class="link" href="#record_validation_filter">3.2. Record Validation filter</a></h3>
<div class="paragraph">
<p>This guide covers using the <strong>Kroxylicious Record Validation Filter</strong> to validate records sent by Kafka client to Kafka brokers.
For information on using the filter, see the <a href="../record-validation-guide/">Kroxylicious Record Validation guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="assembly-multi-tenancy-filter-proxy"><a class="anchor" href="#assembly-multi-tenancy-filter-proxy"></a><a class="link" href="#assembly-multi-tenancy-filter-proxy">3.3. (Preview) Multi-tenancy filter</a></h3>
<div class="paragraph _abstract">
<p>Kroxyliciouss Multi-tenancy filter presents a single Kafka cluster to tenants as if it were multiple clusters.
Operations are isolated to a single tenant by prefixing resources with an identifier.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This filter is currently in incubation and available as a preview.
We would not recommend using it in a production environment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Multi-tenancy filter works by intercepting all Kafka RPCs (remote procedure calls) that reference resources, such as topic names and consumer group names:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Request path</dt>
<dd>
<p>On the request path, resource names are prefixed with a tenant identifier.</p>
</dd>
<dt class="hdlist1">Response path</dt>
<dd>
<p>On the response path, the prefix is removed.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Kafka RPCs that list resources are filtered so that only resources belonging to the tenant are returned, effectively creating a private cluster experience for each tenant.</p>
</div>
<div class="paragraph">
<p>To set up the filter, configure it in Kroxylicious.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
While the Multi-tenancy filter isolates operations on resources, it does not isolate user identities across tenants.
User authentication and ACLs (Access Control Lists) are shared across all tenants, meaning that identity is not scoped to individual tenants.
For more information on open issues related to this filter, see <a href="https://github.com/kroxylicious/kroxylicious/issues" target="_blank" rel="noopener">Kroxylicious issues</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information on Kafka&#8217;s support for multi-tenancy, see the <a href="https://kafka.apache.org" target="_blank" rel="noopener">Apache Kafka website</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="proc-multi-tenancy-proxy"><a class="anchor" href="#proc-multi-tenancy-proxy"></a><a class="link" href="#proc-multi-tenancy-proxy">3.3.1. (Preview) Setting up the Multi-tenancy filter</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to set up the Multi-tenancy filter by configuring it in Kroxylicious.
The filter dynamically prefixes resource names to create isolation between tenants using the same Kafka cluster.
The prefix representing a tenant is taken from the name of the virtual cluster representing the tenant.
For example, if the virtual cluster is named <code>tenant-1</code>, the prefix is <code>tenant-1</code>.
Each tenant must be represented by a unique virtual cluster, and virtual cluster names must be globally unique within the Kroxylicious configuration.
This means that the same virtual cluster name cannot be used to represent different Kafka clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An instance of Kroxylicious.
For information on deploying Kroxylicious, see the <a href="https://github.com/kroxylicious/kroxylicious" target="_blank" rel="noopener">samples and examples</a>.</p>
</li>
<li>
<p>A config map for Kroxylicious that includes the configuration for creating virtual clusters and filters.</p>
</li>
<li>
<p>A virtual cluster definition for each tenant using the Kafka cluster.
You need at least two virtual clusters to apply multi-tenancy.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure a <code>MultiTenant</code> type filter.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">filterDefinitions:
  - name: my-multi-tenant-filter
    type: MultiTenant
    config:
      prefixResourceNameSeparator: "." <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The separator used for the prefix.
If a separator is not specified, <code>-</code> is the default.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, only the prefix with separator is validated.
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
</li>
<li>
<p>Verify that multi-tenancy filtering has been applied.</p>
<div class="paragraph">
<p>For example, create a topic through each virtual cluster and check that the topics are prefixed with the name of the corresponding virtual cluster.</p>
</div>
<div class="paragraph">
<p>For more information, see the <a href="https://github.com/kroxylicious/kroxylicious/blob/main/kubernetes-examples/filters/multi-tenant/script.txt">example for a Kubernetes environment</a>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-oauthbearer-proxy"><a class="anchor" href="#con-oauthbearer-proxy"></a><a class="link" href="#con-oauthbearer-proxy">3.4. OAUTHBEARER validation</a></h3>
<div class="paragraph _abstract">
<p>OauthBearerValidation filter enables a validation on the JWT token received from client before forwarding it to cluster.</p>
</div>
<div class="paragraph">
<p>If the token is not validated, then the request is short-circuited.
It reduces resource consumption on the cluster when a client sends too many invalid SASL requests.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_assets/oauth-bearer-validation-seq.svg" alt="Sequence diagram showing the filter validating the oauth token before it reaches the broker.">
</div>
<div class="title">Figure 5. Sequence diagram showing the filter validating the oauth token before it reaches the broker.</div>
</div>
<div class="sect3">
<h4 id="how_to_use_the_filter"><a class="anchor" href="#how_to_use_the_filter"></a><a class="link" href="#how_to_use_the_filter">3.4.1. How to use the filter</a></h4>
<div class="paragraph">
<p>There are two steps to using the filter.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#con-configuring-virtual-clusters-proxy">Configuring virtual clusters</a></p>
</li>
<li>
<p>Configuring the filter within Kroxylicious.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="configuring_the_filter_within_kroxylicious"><a class="anchor" href="#configuring_the_filter_within_kroxylicious"></a><a class="link" href="#configuring_the_filter_within_kroxylicious">Configuring the filter within Kroxylicious.</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">filterDefinitions:
  - name: my-oauth-filter
    type: OauthBearerValidation
    config:
      jwksEndpointUrl: https://oauth/JWKS   <i class="conum" data-value="1"></i><b>(1)</b>
      jwksEndpointRefreshMs: 3600000        <i class="conum" data-value="2"></i><b>(2)</b>
      jwksEndpointRetryBackoffMs: 100       <i class="conum" data-value="3"></i><b>(3)</b>
      jwksEndpointRetryBackoffMaxMs: 10000  <i class="conum" data-value="4"></i><b>(4)</b>
      scopeClaimName: scope                 <i class="conum" data-value="5"></i><b>(5)</b>
      subClaimName: sub                     <i class="conum" data-value="6"></i><b>(6)</b>
      authenticateBackOffMaxMs: 60000       <i class="conum" data-value="7"></i><b>(7)</b>
      authenticateCacheMaxSize: 1000        <i class="conum" data-value="8"></i><b>(8)</b>
      expectedAudience: https://first.audience, https//second.audience <i class="conum" data-value="9"></i><b>(9)</b>
      expectedIssuer: https://your-domain.auth/ <i class="conum" data-value="10"></i><b>(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The OAuth/OIDC provider URL from which the provider&#8217;s JWKS (JSON Web Key Set) can be retrieved.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The (optional) value in milliseconds for the broker to wait between refreshing its JWKS (JSON Web Key Set) cache that contains the keys to verify the signature of the JWT.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The (optional) value in milliseconds for the initial wait between JWKS (JSON Web Key Set) retrieval attempts from the external authentication provider.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The (optional) value in milliseconds for the maximum wait between attempts to retrieve the JWKS (JSON Web Key Set) from the external authentication provider.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This (optional) setting can provide a different name to use for the scope included in the JWT payload&#8217;s claims.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>This (optional) setting can provide a different name to use for the subject included in the JWT payload&#8217;s claims.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The (optional) maximum value in milliseconds to limit the client sending authenticate request. Setting 0 will never limit the client. Otherwise, an exponential delay is added to each authenticate request until the authenticateBackOffMaxMs has been reached.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The (optional) maximum number of failed tokens kept in cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The (optional) comma-delimited setting for the broker to use to verify that the JWT was issued for one of the expected audiences.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The (optional) setting for the broker to use to verify that the JWT was created by the expected issuer.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note: OauthBearer config follows <a href="https://kafka.apache.org/documentation/#security_ssl">kafka&#8217;s properties</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="con-community-filters-proxy"><a class="anchor" href="#con-community-filters-proxy"></a><a class="link" href="#con-community-filters-proxy">4. Community filters</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Community contributed filters are showcased in the
<a href="https://github.com/kroxylicious/kroxylicious-community-gallery" target="_blank" rel="noopener">Community Gallery</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
These filters are contributed by the community and are not managed or maintained by the Kroxylicious team.
Use them at your own risk.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-proxy-monitoring-proxy"><a class="anchor" href="#assembly-proxy-monitoring-proxy"></a><a class="link" href="#assembly-proxy-monitoring-proxy">5. Monitoring proxies</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Kroxylicious supports key observability features to help you understand the performance and health of your proxy instances.</p>
</div>
<div class="paragraph">
<p>The Kroxylicious Proxy supports real-time monitoring and alerting by emitting system metrics.
You can configure metric emission within the proxy and integrate it with a monitoring system like Prometheus to ingest and analyze the data.</p>
</div>
<div class="paragraph">
<p>The Kroxylicious Proxy writes a log so that its actions may be understood over time.
You can adjust log levels and customize logging as described in this section.</p>
</div>
<div class="sect2">
<h3 id="proc-proxy-introducing-metrics-proxy"><a class="anchor" href="#proc-proxy-introducing-metrics-proxy"></a><a class="link" href="#proc-proxy-introducing-metrics-proxy">5.1. Introducing metrics</a></h3>
<div class="paragraph _abstract">
<p>If you want to introduce metrics to your Kroxylicious deployment, you can configure an insecure HTTP and Prometheus endpoint (at <code>/metrics</code>).</p>
</div>
<div class="paragraph">
<p>Add the following to the <code>ConfigMap</code> resource that defines the Kroxylicious configuration:</p>
</div>
<div class="listingblock">
<div class="title">Minimal metrics configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">management:
  endpoints:
    prometheus: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the HTTP endpoint listens on <code>0.0.0.0:9190</code>.
You can change the bind address and port as follows:</p>
</div>
<div class="listingblock">
<div class="title">Example metrics configuration with bind address and port</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">management:
  bindAddress: 127.0.0.1
  port: 9999
  endpoints:
    prometheus: {}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-prometheus-metrics-proxy-proxy"><a class="anchor" href="#con-prometheus-metrics-proxy-proxy"></a><a class="link" href="#con-prometheus-metrics-proxy-proxy">5.2. Overview of proxy metrics</a></h3>
<div class="paragraph _abstract">
<p>The proxy provides metrics for both connections and messages.
These metrics are categorized into downstream (client-side) and upstream (broker-side) groups
They allow users to assess the impact of the proxy and its filters on their Kafka system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connection metrics count the connections made from the downstream (incoming connections from the clients) and the connection made by the proxy to upstream (outgoing connections to the Kafka brokers).</p>
</li>
<li>
<p>Message metrics count the number of <a href="https://kafka.apache.org/protocol.html#protocol_messages">Kafka protocol request and response messages</a> that flow through the proxy.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="connection_metrics"><a class="anchor" href="#connection_metrics"></a><a class="link" href="#connection_metrics">5.2.1. Connection metrics</a></h4>
<div class="paragraph">
<p>Connection metrics count the TCP connections made from the client to the proxy (<code>kroxylicious_client_to_proxy_request_total</code>) and from the proxy to the broker (<code>kroxylicious_proxy_to_server_connections_total</code>).
These metrics count connection <em>attempts</em>, so the connection count is incremented even if the connection attempt ultimately fails.</p>
</div>
<div class="paragraph">
<p>In addition to the count metrics, there are error metrics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If an error occurs whilst the proxy is accepting a connection from the client the <code>kroxylicious_client_to_proxy_errors_total</code> metric is incremented by one.</p>
</li>
<li>
<p>If an error occurs whilst the proxy is attempting a connection to a broker the <code>kroxylicious_proxy_to_server_errors_total</code> metric is incremented by one.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Connection and connection error metrics include the following labels: <code>virtual_cluster</code> (the virtual cluster&#8217;s name) and <code>node_id</code> (the broker&#8217;s node ID).
When the client connects to the boostrap endpoint of the virtual cluster, a node ID value of <code>bootstrap</code> is recorded.</p>
</div>
<div class="paragraph">
<p>The <code>kroxylicious_client_to_proxy_errors_total</code> metric also counts connection errors that occur before a virtual cluster has been identified.
For these specific errors, the <code>virtual_cluster</code> and <code>node_id</code> labels are set to an empty string ("").</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Error conditions signaled <em>within</em> the Kafka protocol response (such as <code>RESOURCE_NOT_FOUND</code> or <code>UNKNOWN_TOPIC_ID</code>) are not classed as errors by these metrics.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Connection metrics for client and broker interactions</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Labels</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_client_to_proxy_connection_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by one every time a connection is accepted from a client by the proxy.<br>
 This metric counts all connection attempts that reach the proxy, even those that end in error.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_client_to_proxy_errors_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by one every time a connection is closed due to any downstream error.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_proxy_to_server_connections_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by one every time a connection is made to the server from the proxy.<br>
 This metric counts all connections attempted to the broker, even those that end in error.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_proxy_to_server_errors_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by one every time a connection is closed due to any upstream error.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="message_metrics"><a class="anchor" href="#message_metrics"></a><a class="link" href="#message_metrics">5.2.2. Message metrics</a></h4>
<div class="paragraph">
<p>Message metrics count and record the sizes of the Kafka protocol requests and responses that flow through the proxy.</p>
</div>
<div class="paragraph">
<p>Use these metrics to help understand:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the number of messages flowing through the proxy.</p>
</li>
<li>
<p>the overall volume of data through the proxy.</p>
</li>
<li>
<p>the effect the filters are having on the messages.</p>
</li>
<li>
<p>Downstream metrics</p>
<div class="ulist">
<ul>
<li>
<p><code>kroxylicious_client_to_proxy_request_total</code> counts requests as they arrive from the client.</p>
</li>
<li>
<p><code>kroxylicious_proxy_to_client_response_total</code> counts responses as they are returned to the client.</p>
</li>
<li>
<p><code>kroxylicious_client_to_proxy_request_size_bytes</code> is incremented by the size of each request as it arrives from the client.</p>
</li>
<li>
<p><code>kroxylicious_proxy_to_client_response_size_bytes</code> is incremented by the size of each response as it is returned to the client.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Upstream metrics</p>
<div class="ulist">
<ul>
<li>
<p><code>kroxylicious_proxy_to_server_request_total</code> counts requests as they go to the broker.</p>
</li>
<li>
<p><code>kroxylicious_proxy_to_server_response_total</code> counts responses as they are returned by the broker.</p>
</li>
<li>
<p><code>kroxylicious_proxy_to_server_request_size_bytes</code> is incremented by the size of each request as it goes to the broker.</p>
</li>
<li>
<p><code>kroxylicious_proxy_to_server_response_size_bytes</code> is incremented by the size of each response as it is returned by the broker.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The size recorded is the encoded size of the protocol message. It includes the 4 byte <a href="https://kafka.apache.org/protocol.html#protocol_common">message size</a>.</p>
</div>
<div class="paragraph">
<p>Filters can alter the flow of messages through the proxy or the content of the message.
This is apparent through the metrics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a filter sends a short-circuit, or closes a connection the downstream message counters will exceed the upstream counters.</p>
</li>
<li>
<p>If a filter changes the size of the message, the downstream size metrics will be different to the upstream size metrics.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="../_assets/monitoring-message-counters.svg" alt="Conceptual diagram showing the downstream and upstream message metrics within the proxy, illustrating how they respond to message transit through it.">
</div>
<div class="title">Figure 6. Downstream and upstream message metrics in the proxy</div>
</div>
<div class="paragraph">
<p>Message metrics include the following labels: <code>virtual_cluster</code> (the virtual cluster&#8217;s name), <code>node_id</code> (the broker&#8217;s node ID), <code>api_key</code> (the message type), <code>api_version</code>, and <code>decoded</code> (a flag indicating if the message was decoded by the proxy).</p>
</div>
<div class="paragraph">
<p>When the client connects to the boostrap endpoint of the virtual cluster, metrics are recorded with a node ID value of <code>bootstrap</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Kafka message metrics for proxy request and response flow</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Labels</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_client_to_proxy_request_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by one every time a request arrives at the proxy from a client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_proxy_to_server_request_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by one every time a request goes from the proxy to a server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_server_to_proxy_response_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by one every time a response arrives at the proxy from a server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_proxy_to_client_response_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by one every time a response goes from the proxy to a client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_client_to_proxy_request_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distribution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by the size of the message each time a request arrives at the proxy from a client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_proxy_to_server_request_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distribution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by the size of the message each time a request goes from the proxy to a server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_server_to_proxy_response_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distribution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by the size of the message each time a response arrives at the proxy from a server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kroxylicious_proxy_to_client_response_total</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distribution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incremented by the size of the message each time a response goes from the proxy to a client.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="con-proxy-ingesting-metrics-proxy"><a class="anchor" href="#con-proxy-ingesting-metrics-proxy"></a><a class="link" href="#con-proxy-ingesting-metrics-proxy">5.3. Ingesting metrics</a></h3>
<div class="paragraph _abstract">
<p>Metrics from the Kroxylicious Proxy can be ingested into your Prometheus instance.</p>
</div>
<div class="paragraph">
<p>Configure the <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config"><code>scrape_configs</code></a> property to enable
Prometheus to scrape the monitors from your proxy instances.</p>
</div>
<div class="listingblock">
<div class="title">Example Prometheus scrape config</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">scrape_configs:
  - job_name: 'kroxylicious'
    static_configs:
      - targets: ['proxyhost:9190'] <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The host that is running the Kroxylicious instance and the port number assigned to management.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="con-proxy-integrating-micrometer-proxy"><a class="anchor" href="#con-proxy-integrating-micrometer-proxy"></a><a class="link" href="#con-proxy-integrating-micrometer-proxy">5.4. Integrating Micrometer</a></h3>
<div class="paragraph">
<p>Kroxylicious integrates with <a href="https://micrometer.io/docs">Micrometer</a> for gathering metrics.</p>
</div>
<div class="paragraph">
<p>Micrometer provides a simple facade over instrumentation clients for popular observability systems, allowing you to instrument your JVM-based application code without vendor lock-in.
The following example shows how to define the <code>CommonTagsHook</code> and <code>StandardBindersHook</code> types to add a label to metrics and register a JVM metrics binder.</p>
</div>
<div class="listingblock">
<div class="title">Example proxy configuration for Micrometer integration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">management:
  endpoints:
    prometheus: {}
micrometer:
  - type: "CommonTagsHook" <i class="conum" data-value="1"></i><b>(1)</b>
    config:
      commonTags:
        zone: "euc-1a" <i class="conum" data-value="2"></i><b>(2)</b>
  - type: "StandardBindersHook" <i class="conum" data-value="3"></i><b>(3)</b>
    config:
      binderNames:
      - "JvmGcMetrics" <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies the <code>CommonTagsHook</code> type to add common tags to all metrics.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Adds common tag zone <code>euc-1a</code> to all metrics in the global registry included with Micrometer, which appears as a label in Prometheus.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies the <code>StandardBindersHook</code> type to register standard Micrometer binders.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Registers the <code>JvmGcMetrics</code> binder with the global registry.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Prometheus is connected to the Micrometer global registry, so filters can record metrics against it as part of the Prometheus scrape data.</p>
</div>
<div class="paragraph">
<p>Using the <code>curl localhost:9190/metrics</code> command shows metrics as follows:</p>
</div>
<div class="listingblock">
<div class="title">Example metrics returned from request</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">jvm_gc_memory_allocated_bytes_total{zone="euc-1a",} 0.0</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="common_tags"><a class="anchor" href="#common_tags"></a><a class="link" href="#common_tags">5.4.1. Common tags</a></h4>
<div class="paragraph">
<p>Add common tags for metrics to appear as labels in the Prometheus scrape.</p>
</div>
<div class="listingblock">
<div class="title">Example common tag configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- type: "CommonTagsHook"
  config:
    commonTags:
      zone: "euc-1a"
      owner: "team-a"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="standard_binders"><a class="anchor" href="#standard_binders"></a><a class="link" href="#standard_binders">5.4.2. Standard binders</a></h4>
<div class="paragraph">
<p>Micrometer uses the concept of meter binders to register metrics that provide information about the state of some aspect of the application or its container.
By registering standard binders included with Micrometer, you can expose metrics about the JVM and system, such as JVM memory usage and garbage collection.</p>
</div>
<div class="listingblock">
<div class="title">Example binders configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micrometer:
  - type: "StandardBindersHook"
    config:
      binderNames:
      - "JvmGcMetrics"
      - "JvmHeapPressureMetrics"</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Standard binders available with Micrometer</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Micrometer class</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ClassLoaderMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.ClassLoaderMetrics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JvmCompilationMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmCompilationMetrics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JvmGcMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmGcMetrics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JvmHeapPressureMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmHeapPressureMetrics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JvmInfoMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmInfoMetrics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JvmMemoryMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmMemoryMetrics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JvmThreadMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmThreadMetrics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FileDescriptorMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.system.FileDescriptorMetrics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ProcessorMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.system.ProcessorMetrics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UptimeMetrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.micrometer.core.instrument.binder.system.UptimeMetrics</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="pause_detector"><a class="anchor" href="#pause_detector"></a><a class="link" href="#pause_detector">5.4.3. Pause detector</a></h4>
<div class="paragraph">
<p>Micrometer offers a pause detector (using the <a href="https://latencyutils.github.io/LatencyUtils/" target="_blank" rel="noopener">LatencyUtils</a> package) which attempts to compensate for
 requests which would have been accepted and delayed by a pause arising from a source external
 to the monitored section (There are a wide variety of possible sources such as Garbage collectors
 or system pauses).
Micrometer defaults to a no-op pause detector implementation, but it also provides a clock drift based
 implementation which can be optionally configured.
The clock drift based pause detector can be configured by providing a sleep interval a pause threshold.
These values are defaulted to the Micrometer recommended <code>100ms</code> but you can choose to configure
 different values based on your environment.
Using the clock drift based pause detector can result in samples being added to timers in
 unexpected ways in some degenerate cases so users are advised to use it after careful consideration.</p>
</div>
<div class="paragraph">
<p>See <a href="https://micrometer.io/docs/concepts#_pause_detection" target="_blank" rel="noopener">Micrometer Pause Detection</a></p>
</div>
<div class="listingblock">
<div class="title">Example pause detector configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micrometer:
  - type: "PauseDetectorHook"
    config:
      sleepIntervalMs: 500
      pauseThresholdMs: 500</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using_micrometer_with_filters"><a class="anchor" href="#using_micrometer_with_filters"></a><a class="link" href="#using_micrometer_with_filters">5.4.4. Using Micrometer with filters</a></h4>
<div class="paragraph">
<p>Use the static methods of <a href="https://www.javadoc.io/doc/io.micrometer/micrometer-core/1.10.5/io/micrometer/core/instrument/Metrics.html" target="_blank" rel="noopener">Micrometer Metrics</a> to register metrics with the global registry.</p>
</div>
<div class="paragraph">
<p>Alternatively, use <code>Metrics.globalRegistry</code> to get a reference to the global registry.
Metrics registered this way are automatically available through the Prometheus scrape endpoint.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-proxy-setting-log-levels-proxy"><a class="anchor" href="#proc-proxy-setting-log-levels-proxy"></a><a class="link" href="#proc-proxy-setting-log-levels-proxy">5.5. Setting log levels</a></h3>
<div class="paragraph _abstract">
<p>The Kroxylicious <a href="https://github.com/kroxylicious/kroxylicious/tree/main" target="_blank" rel="noopener">binary distribution</a> includes <a href="https://logging.apache.org/log4j/2.x">log4j2</a> as the default logging backend.</p>
</div>
<div class="paragraph">
<p>When using the <code>bin/kroxylicious-start.sh</code> script from the binary distribution, you can set an environment variable to load a custom <code>log4j2</code> configuration file or change the root logging level.</p>
</div>
<div class="listingblock">
<div class="title">Environment variable to load a custom <code>log4j2</code> file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">KROXYLICIOUS_LOGGING_OPTIONS="-Dlog4j2.configurationFile=/path/to/custom/log4j2.yaml"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Environment variable to change the root logging level</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">KROXYLICIOUS_ROOT_LOG_LEVEL="DEBUG"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Setting the root log level to <code>DEBUG</code> or <code>TRACE</code> will produce very verbose logs.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trademark_notice"><a class="anchor" href="#trademark_notice"></a><a class="link" href="#trademark_notice">6. Trademark notice</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Apache Kafka is a registered trademark of The Apache Software Foundation.</p>
</li>
<li>
<p>Kubernetes is a registered trademark of The Linux Foundation.</p>
</li>
<li>
<p>Prometheus is a registered trademark of The Linux Foundation.</p>
</li>
<li>
<p>Strimzi is a trademark of The Linux Foundation.</p>
</li>
<li>
<p>Hashicorp Vault is a registered trademark of HashiCorp, Inc.</p>
</li>
<li>
<p>AWS Key Management Service is a trademark of Amazon.com, Inc. or its affiliates.</p>
</li>
<li>
<p>Fortanix and Data Security Manager are trademarks of Fortanix, Inc.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-07-17 17:38:31 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>