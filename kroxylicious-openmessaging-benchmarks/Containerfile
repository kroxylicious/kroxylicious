#
# Copyright Kroxylicious Authors.
#
# Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0
#

# Multi-stage build for OpenMessaging Benchmark (OMB).
# The published openmessaging/openmessaging-benchmark:latest image ships
# Kafka client 1.0.0 on Java 8.  This Containerfile builds from the
# current upstream source (Kafka 3.6.1, JDK 17).

# Upstream OMB has no tags or releases â€” pin to a known-good commit on master.
ARG OMB_COMMIT=85599891321cafa2fb7065a63f009b4bb5374288

# ---------- Stage 1: build ----------
FROM maven:3-eclipse-temurin-17 AS builder

ARG OMB_COMMIT
RUN apt-get update && apt-get install -y --no-install-recommends git && rm -rf /var/lib/apt/lists/*

RUN git clone https://github.com/openmessaging/benchmark.git /build && \
    cd /build && git checkout ${OMB_COMMIT}

WORKDIR /build
RUN mvn clean package -DskipTests

# ---------- Stage 2: runtime ----------
FROM eclipse-temurin:17

RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*

COPY --from=builder /build/package/target/openmessaging-benchmark-*-bin.tar.gz /tmp/omb.tar.gz
RUN mkdir -p /benchmark && \
    tar -xzf /tmp/omb.tar.gz --strip-components=1 -C /benchmark && \
    rm /tmp/omb.tar.gz

WORKDIR /benchmark
